<div class="container-fluid bg-light min-vh-100">
  <!-- Apple-inspired Fixed Header using Bootstrap -->
  <div class="sticky-top bg-white bg-opacity-95 border-bottom shadow-sm backdrop-blur">
    <div class="container-xxl">
      <!-- Main Search Section -->
      <div class="py-3">
        <div class="row align-items-center">
          <div class="col-lg-8">
            <form (ngSubmit)="onSearchSubmit()" novalidate>
              <div class="d-flex gap-2 align-items-stretch flex-wrap">
                <div class="flex-fill" style="min-width: 150px;">
                  <input
                    type="text"
                    id="searchStreet"
                    class="form-control rounded-3"
                    placeholder="Street"
                    [value]="addressSearch().street"
                    (input)="onSearchInput($event, 'street')"
                    required
                  />
                </div>
                <div class="flex-md-grow-0" style="flex: 0 0 80px; min-width: 70px;">
                  <input
                    type="text"
                    id="searchHouseNumber"
                    class="form-control rounded-3"
                    placeholder="No."
                    [value]="addressSearch().houseNumber"
                    (input)="onSearchInput($event, 'houseNumber')"
                    required
                  />
                </div>
                <div class="flex-fill" style="min-width: 120px;">
                  <input
                    type="text"
                    id="searchCity"
                    class="form-control rounded-3"
                    placeholder="City"
                    [value]="addressSearch().city"
                    (input)="onSearchInput($event, 'city')"
                    required
                  />
                </div>
                <div class="flex-md-grow-0" style="flex: 0 0 80px; min-width: 70px;">
                  <input
                    type="text"
                    id="searchZipCode"
                    class="form-control rounded-3"
                    placeholder="ZIP"
                    [value]="addressSearch().zipCode"
                    (input)="onSearchInput($event, 'zipCode')"
                    pattern="[0-9]{5}"
                    required
                  />
                </div>
                <div class="flex-md-grow-0" style="flex: 0 0 44px; min-width: 44px;">
                  <button
                    type="submit"
                    class="btn btn-primary w-100 h-100 rounded-3"
                    [disabled]="!isSearchFormValid()"
                    title="Search"
                  >
                    <fa-icon [icon]="faSearch"></fa-icon>
                  </button>
                </div>
              </div>
            </form>
          </div>

          <div class="col-lg-4 d-flex align-items-center justify-content-end">
            <div class="d-flex align-items-center gap-3">
              <!-- Share Button -->
              <button
                class="btn btn-outline-primary rounded-pill"
                (click)="shareQuery()"
                title="Share this search"
              >
                <fa-icon [icon]="faShareAlt" class="pe-1"></fa-icon>                 
                Share
              </button>

              <!-- Results Count -->
              @if (state.isLoading()) {
              <div class="d-flex align-items-center text-muted">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                  <span class="visually-hidden fs-6">Loading...</span>
                </div>
                <small>Searching...</small>
              </div>
              } @else {
              <span class="badge bg-success rounded-pill p-2 fs-6">
                {{ filteredOffers().length }} offers
              </span>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="pb-3 border-top border-light">
        <div class="pt-3">
          <div class="d-flex align-items-center gap-2 gap-md-3 flex-wrap">
            <select
              class="form-select form-select-sm rounded-2 flex-shrink-0"
              [(ngModel)]="filter().provider"
              (ngModelChange)="updateFilter('provider', $event)"
              style="width: auto; min-width: 140px;"
            >
              <option value="" selected>All Providers</option>
              @for (provider of availableProviders(); track provider) {
              <option [value]="provider">{{ provider }}</option>
              }
            </select>

            <select
              class="form-select form-select-sm rounded-2 flex-shrink-0"
              [(ngModel)]="filter().connectionType"
              (ngModelChange)="updateFilter('connectionType', $event)"
              style="width: auto; min-width: 140px;"
            >
              <option value="" selected>All Types</option>
              @for (type of availableConnectionTypes(); track type) {
              <option [value]="type">{{ type }}</option>
              }
            </select>

            <input
              type="number"
              class="form-control form-control-sm rounded-2 flex-shrink-0"
              style="width: 140px;"
              [(ngModel)]="filter().speedMin"
              (ngModelChange)="updateFilter('speedMin', $event)"
              placeholder="Min Speed (Mbps)"
              min="0"
            />

            <input
              type="number"
              class="form-control form-control-sm rounded-2 flex-shrink-0"
              style="width: 140px;"
              [(ngModel)]="filter().costMax"
              (ngModelChange)="updateFilter('costMax', $event)"
              placeholder="Max Cost (â‚¬)"
              min="0"
            />

            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                role="switch"
                id="requireInstallation"
                [(ngModel)]="filter().installation"
                (ngModelChange)="updateFilter('installation', $event)"
              />
              <label class="form-check-label fw-medium" for="requireInstallation">
                Installation
              </label>
            </div>
          </div>

          <!-- Active Filters -->
          @if (activeFilters().length > 0) {
          <div class="d-flex align-items-center gap-2 flex-wrap mt-3">
            @for (filter of activeFilters(); track filter.type) {
            <span class="badge bg-primary bg-opacity-10 text-primary border border-primary rounded-pill d-flex align-items-center gap-1 p-2">
              <small class="fw-medium">{{ filter.label }}</small>
              <button
                type="button"
                class="btn-close"
                style="font-size: 0.6rem;"
                (click)="removeFilter(filter.type)"
                aria-label="Remove filter"
              ></button>
            </span>
            }
            <button 
              class="btn btn-sm btn-outline-danger rounded-pill"
              (click)="clearFilters()"
            >
              <fa-icon [icon]="faClose"></fa-icon>
              Clear All
            </button>
          </div>
          }
        </div>
      </div>
    </div>
  </div>

  <div class="container pt-4">
    <!-- Loading State -->
    @if (state.isLoading() && filteredOffers().length === 0) {
    <div class="text-center py-5">
      <div class="d-flex justify-content-center mb-4">
        <div
          class="spinner-border text-primary"
          role="status"
          style="width: 3rem; height: 3rem"
        >
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <h4 class="text-muted mb-2">
        Fetching offers from multiple providers...
      </h4>
      <p class="text-muted">This may take a few moments</p>
    </div>
    }

    <!-- Error State -->
    @if (state.error(); as error) {
    <div class="alert alert-danger border-0 shadow-sm text-center" role="alert">
      <div class="mb-3">
        <fa-icon [icon]="faExclamationTriangle" class="text-danger"></fa-icon>

        <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
      </div>
      <h4 class="alert-heading">Error Loading Offers</h4>
      <p class="mb-3">{{ error }}</p>
      <button class="btn btn-danger" (click)="retrySearch()">
        <fa-icon [icon]="faRedo"></fa-icon>
        Try Again
      </button>
    </div>
    }

    <!-- Results -->
    @if (filteredOffers().length > 0) {
    <div class="row g-4">
      @for (offer of filteredOffers(); track offer.offerHash) {
      <div class="col-md-6 col-lg-4">
        <app-offer-card [offer]="offer"></app-offer-card>
      </div>
      }
    </div>
    } @else if (!state.isLoading() && !state.error()) {
    <div class="text-center py-5">
      <div class="mb-4">
        <i class="fas fa-search fa-3x text-muted"></i>
      </div>
      <h4 class="text-muted mb-2">No offers found</h4>
      <p class="text-muted mb-4">
        Try adjusting your filters or search criteria.
      </p>
      <button class="btn btn-primary" (click)="clearFilters()">
        <i class="fas fa-filter me-1"></i>
        Clear Filters
      </button>
    </div>
    }
  </div>
</div>
